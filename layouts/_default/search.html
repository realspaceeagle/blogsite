{{- define "main" }}

<header class="page-header">
    <h1>{{- (printf "%s&nbsp;" .Title ) | htmlUnescape -}}
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
    </h1>
    {{- if .Description }}
    <div class="post-description">
        {{ .Description }}
    </div>
    {{- end }}
    {{- if not (.Param "hideMeta") }}
    <div class="post-meta">
        {{- partial "translation_list.html" . -}}
    </div>
    {{- end }}
</header>

<div class="search-simple">
    <div class="search-description">
        <p id="searchDescription">Search posts, pages, and notes across the site</p>
    </div>
    <div id="searchbox">
        <input id="searchInput" autofocus placeholder="{{ .Params.placeholder | default (printf "%s " .Title) }}"
            aria-label="search" type="search" autocomplete="off" maxlength="64">
        <ul id="searchResults" aria-label="search results"></ul>
    </div>
</div>

<style>
.search-simple {
    max-width: 720px;
    margin: 0 auto;
}

.search-description {
    text-align: center;
    margin-bottom: 16px;
}

.search-description p {
    color: var(--secondary);
    font-size: 15px;
    margin: 0;
}

#searchbox input {
    width: 100%;
    padding: 0.8rem 1rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--theme);
    color: var(--primary);
    font-size: 1rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#searchbox input:focus {
    outline: none;
    border-color: rgba(102, 126, 234, 0.65);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
}

#searchResults {
    list-style: none;
    margin: 1.5rem 0 0;
    padding: 0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const normalSearchBtn = document.getElementById('normalSearchBtn');
    const enhancedSearchBtn = document.getElementById('enhancedSearchBtn');
    const searchDescription = document.getElementById('searchDescription');
    const searchFilters = document.getElementById('searchFilters');
    const searchStats = document.getElementById('searchStats');
    const searchResults = document.getElementById('searchResults');
    
    let searchMode = 'normal';
    let originalFuseOptions = null;
    
    // Search mode descriptions
    const descriptions = {
        normal: 'Quick search through titles and summaries',
        enhanced: 'Deep search through full content with advanced filters and snippets'
    };
    
    // Toggle search modes
    function switchSearchMode(mode) {
        searchMode = mode;
        
        // Update button states
        normalSearchBtn.classList.toggle('active', mode === 'normal');
        enhancedSearchBtn.classList.toggle('active', mode === 'enhanced');
        
        // Update description
        searchDescription.textContent = descriptions[mode];
        
        // Show/hide filters
        searchFilters.style.display = mode === 'enhanced' ? 'flex' : 'none';
        
        // Update search container class
        document.querySelector('.enhanced-search-container').className = 
            'enhanced-search-container' + (mode === 'enhanced' ? ' enhanced-search' : '');
        
        // Clear current results
        searchResults.innerHTML = '';
        searchStats.style.display = 'none';
        
        // Update search options if fuse is available
        if (window.fuse && mode === 'enhanced') {
            setupEnhancedSearch();
        }
    }
    
    function setupEnhancedSearch() {
        // Store original options if not already stored
        if (!originalFuseOptions && window.fuse) {
            originalFuseOptions = window.fuse.options;
        }
        
        // Enhanced search options
        const enhancedOptions = {
            ...originalFuseOptions,
            includeMatches: true,
            includeScore: true,
            threshold: 0.3, // More lenient for content search
            distance: 200,
            minMatchCharLength: 2,
            keys: [
                { name: 'title', weight: 3 },
                { name: 'summary', weight: 2 },
                { name: 'content', weight: 1 },
                { name: 'tags', weight: 2 }
            ]
        };
        
        // Update fuse options
        if (window.fuseData) {
            window.fuse = new Fuse(window.fuseData, enhancedOptions);
        }
    }
    
    // Event listeners
    normalSearchBtn.addEventListener('click', () => {
        switchSearchMode('normal');
        // Dispatch custom event for enhanced search script
        document.dispatchEvent(new CustomEvent('searchModeChanged', { 
            detail: { mode: 'normal' } 
        }));
    });
    
    enhancedSearchBtn.addEventListener('click', () => {
        switchSearchMode('enhanced');
        // Dispatch custom event for enhanced search script
        document.dispatchEvent(new CustomEvent('searchModeChanged', { 
            detail: { mode: 'enhanced' } 
        }));
        
        // Force re-search if there's a query
        const query = document.getElementById('searchInput').value.trim();
        if (query && window.enhancedSearchEnabled) {
            console.log('Forcing enhanced search for query:', query);
            setTimeout(() => {
                if (window.search) {
                    window.search(query, 'enhanced');
                }
            }, 100);
        }
    });
    
    // Initialize
    switchSearchMode('normal');
    
    // The actual search functionality is handled by enhanced-search.js
    
    // Direct search input handler that bypasses original search completely
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        // Stop propagation to prevent original search from running
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        console.log('Direct input handler - Mode:', searchMode, 'Query:', query);
        
        if (searchMode === 'enhanced' && query) {
            console.log('Calling enhanced search directly');
            if (window.performEnhancedSearchDirect) {
                window.performEnhancedSearchDirect(query);
            }
        } else if (searchMode === 'normal' && query) {
            // For normal mode, let original search handle it
            console.log('Normal search mode');
        } else if (!query) {
            document.getElementById('searchResults').innerHTML = '';
        }
    }, true); // Use capture phase to run before other handlers
    
    // Filter change handlers - these trigger re-search in enhanced mode
    document.getElementById('categoryFilter').addEventListener('change', function() {
        const query = document.getElementById('searchInput').value;
        if (query && searchMode === 'enhanced' && window.performEnhancedSearchDirect) {
            window.performEnhancedSearchDirect(query);
        }
    });
    
    document.getElementById('sortFilter').addEventListener('change', function() {
        const query = document.getElementById('searchInput').value;
        if (query && searchMode === 'enhanced' && window.performEnhancedSearchDirect) {
            window.performEnhancedSearchDirect(query);
        }
    });
});
</script>

{{- end }}{{/* end main */}}